# This workflow is a test. It creates a Github issue each time an issue is closed.
# It uses the `gh` client with a dedicated Access Token with read/write issues permissions.

name: Assign Project & column to new issue
on:
  # Ref: https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#issues
  issues:
    # opened = created, edited = title or body were edited
    types: [opened,edited]
  # # We also want to be able to run this workflow manually from Github
  # workflow_dispatch:

# permissions:
#   issues: write

env:
  # GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GH_MY_TOKEN: ${{ secrets.GH_MY_TOKEN }} # Personal Accee Token (classic) with scopes: gist, project, read:org, repo, workflow
  GH_PROJECT_ID: embergershared/2
  GH_PROJECT_NAME: 'Contoso University App'

jobs:
  move-assigned-card:
    name: Get issue details
    runs-on: ubuntu-latest
    # runs-on:
    #   # We use a GH organization Self-hosted runner wired in the Private VNET
    #   group: embergershared
    #   labels: 912772
    steps:
      # For 'gh' to work, we need to operate in a git repo
      - name: Checkout
        uses: actions/checkout@v3

      - name: gh auth
        run: |
          echo ${{ secrets.GH_MY_TOKEN }} | gh auth login --with-token

      - name: List issues
        run: |
          echo "List issues:"
          gh issue list
  
      - name: Show edited issue
        run: |
          echo "Getting the issues already in our project"
          IN_PROJ_ISSUES=$(gh issue list -S "project:${{ env.GH_PROJECT_ID }}" --json number --jq .[].number)
          echo "Testing if the trigering issue is already in our project"
          if [[ $IN_PROJ_ISSUES =~ ${{ github.event.issue.number }} ]]; then
            echo "Issue is already in our project: we stop here"
          else
            echo "Issue is not in our project: Adding it!"
            # gh auth refresh -s project --hostname github.com
            # gh auth logout --hostname github.com
            # echo ${{ secrets.GITHUB_TOKEN }} | gh auth refresh -s project --with-token
            gh issue edit ${{ github.event.issue.number }} --add-project '${{ env.GH_PROJECT_NAME }}'
          fi
